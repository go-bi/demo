<!DOCTYPE html>
<!-- saved from url=(0090)https://wtfsec.org/posts/xss-hunter%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95/ -->
<html lang="zh"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="generator" content="Hugo 0.64.0"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name="color-scheme" content="light dark"><meta name="supported-color-schemes" content="light dark"><title>XSS Hunter平台搭建记录&nbsp;–&nbsp;WTFSec</title><link rel="stylesheet" href="./XSS Hunter平台搭建记录 – WTFSec_files/core.min.c09905b8029800c3040c25da67f23499711f4327cef0f32acd9b40c44908b8cb40fd926ead46b3f6f5a6bf9be3de3108.css" integrity="sha384-wJkFuAKYAMMEDCXaZ/I0mXEfQyfO8PMqzZtAxEkIuMtA/ZJurUaz9vWmv5vj3jEI"><link rel="preload" href="./XSS Hunter平台搭建记录 – WTFSec_files/f(1).txt" as="script"><script src="./XSS Hunter平台搭建记录 – WTFSec_files/osd.js.下载"></script><script src="./XSS Hunter平台搭建记录 – WTFSec_files/f.txt" id="google_shimpl"></script><script type="text/javascript" src="./XSS Hunter平台搭建记录 – WTFSec_files/f(1).txt"></script></head><body><div class="base-body"><section id="header" class="site header"><div class="header wrap"><span class="header left-side"><a class="site home" href="https://wtfsec.org/"><span class="site name">WTFSec</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="https://wtfsec.org/categories/">分类</a><a class="nav item" href="https://wtfsec.org/tags/">标签</a><a class="nav item" href="https://wtfsec.org/link/">友链</a>
<input placeholder="Google 站内搜索" id="search_input" style="width:150px">
<button onclick="search()"><svg width="13" height="13" viewBox="0 0 13 13"><title>搜尋</title><path d="m4.8495 7.8226c.82666.0 1.5262-.29146 2.0985-.87438.57232-.58292.86378-1.2877.87438-2.1144.010599-.82666-.28086-1.5262-.87438-2.0985-.59352-.57232-1.293-.86378-2.0985-.87438-.8055-.010599-1.5103.28086-2.1144.87438-.60414.59352-.8956 1.293-.87438 2.0985.021197.8055.31266 1.5103.87438 2.1144.56172.60414 1.2665.8956 2.1144.87438zm4.4695.2115 3.681 3.6819-1.259 1.284-3.6817-3.7.0019784-.69479-.090043-.098846c-.87973.76087-1.92 1.1413-3.1207 1.1413-1.3553.0-2.5025-.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239.4696-2.4966 1.4088-3.4239c.9392-.92727 2.0864-1.3969 3.4417-1.4088 1.3553-.011889 2.4906.45771 3.406 1.4088.9154.95107 1.379 2.0924 1.3909 3.4239.0 1.2126-.38043 2.2588-1.1413 3.1385l.098834.090049z"></path></svg></button></nav></div><script>function search(){const search_value=document.getElementById("search_input").value;if(search_value!==''){window.open("/search/?q="+search_value,"_blank");}}
document.getElementById("search_input").addEventListener("keydown",function(e){if(e.key==="Enter"){search()}});</script></span></div></section><div id="content"><div class="article-container"><section class="article header"><h1 class="article title">XSS Hunter平台搭建记录</h1><p class="article date"><span class="lang"><a>Hzllaga</a> </span>Tuesday, February 25, 2020</p></section><article class="article markdown-body"><blockquote><p>XSS Hunter：<a href="https://github.com/mandatoryprogrammer/xsshunter/" target="_blank">https://github.com/mandatoryprogrammer/xsshunter/</a></p><p>The XSS Hunter service - a portable version of XSSHunter.com</p></blockquote><h2 id="搭建需求">搭建需求：</h2><ul><li>服务器最好是Ubuntu</li><li>一个Mailgun账号，用来发送xss触发时的邮件，由于该平台并非免费，本文将会改为自建发信服务器</li><li>一个域名，越短越好，避免有些地方因字符数量限制无法成功利用</li><li>一个通配符SSL证书，可至SSL FOR FREE网站申请</li></ul><p>首先设置域名的DNS记录：</p><pre><code>    A 记录:
        主机名: @
        内容: 服务器IP
    CNAME 记录:
        主机名： *
        内容: 域名
</code></pre><p><a target="_blank" rel="noopener noreferrer" href="./XSS Hunter平台搭建记录 – WTFSec_files/20200225205745.png"><img src="./XSS Hunter平台搭建记录 – WTFSec_files/20200225205745.png" alt=""></a></p><p>再来安装Nginx:</p><pre><code>sudo apt-get install nginx
</code></pre><p>安装Postgresql：</p><pre><code>sudo apt-get install postgresql postgresql-contrib
</code></pre><p>设定Postgresql：</p><pre><code>sudo -i -u postgres  //切换为postgres用户
psql template1  //登录postgresql
CREATE USER xsshunter WITH PASSWORD 'PASSWORD'; //新建账号为xsshunter，密码为PASSWORD的用户
CREATE DATABASE xsshunter;  //新建名为xsshunter的数据库
\q  //退出postgresql
exit  //回到原本的用户
</code></pre><p>下载最新版XSSHunter：</p><pre><code>git clone https://github.com/mandatoryprogrammer/xsshunter
</code></pre><h2 id="配置自己的发信服务器">配置自己的发信服务器</h2><p>如果有钱的朋友可以直接买Mailgun服务并跳过这一段，先来看看程序是怎么发邮件的：</p><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span> <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">attachment_file</span><span class="p">,</span> <span class="n">body_type</span><span class="o">=</span><span class="sa"></span><span class="s2">"</span><span class="s2">html</span><span class="s2">"</span> <span class="p">)</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">body_type</span> <span class="o">==</span> <span class="sa"></span><span class="s2">"</span><span class="s2">html</span><span class="s2">"</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">+</span><span class="o">=</span> <span class="sa"></span><span class="s2">"</span><span class="s2">&lt;br /&gt;&lt;img src=</span><span class="se">\"</span><span class="s2">https://api.</span><span class="s2">"</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="sa"></span><span class="s2">"</span><span class="s2">domain</span><span class="s2">"</span><span class="p">]</span> <span class="o">+</span> <span class="sa"></span><span class="s2">"</span><span class="s2">/</span><span class="s2">"</span> <span class="o">+</span> <span class="n">attachment_file</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span> <span class="sa"></span><span class="s2">"</span><span class="s2">utf-8</span><span class="s2">"</span> <span class="p">)</span> <span class="o">+</span> <span class="sa"></span><span class="s2">"</span><span class="se">\"</span><span class="s2"> /&gt;</span><span class="s2">"</span> <span class="c1"># I'm so sorry.</span>

    <span class="n">email_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa"></span><span class="s2">"</span><span class="s2">from</span><span class="s2">"</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span> <span class="n">settings</span><span class="p">[</span><span class="sa"></span><span class="s2">"</span><span class="s2">email_from</span><span class="s2">"</span><span class="p">]</span> <span class="p">)</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">"</span><span class="s2">to</span><span class="s2">"</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span> <span class="n">to</span> <span class="p">)</span><span class="p">,</span>
        <span class="sa"></span><span class="s2">"</span><span class="s2">subject</span><span class="s2">"</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span> <span class="n">subject</span> <span class="p">)</span><span class="p">,</span>
        <span class="n">body_type</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span> <span class="n">body</span> <span class="p">)</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">thread</span> <span class="o">=</span> <span class="n">unirest</span><span class="o">.</span><span class="n">post</span><span class="p">(</span> <span class="sa"></span><span class="s2">"</span><span class="s2">https://api.mailgun.net/v3/</span><span class="s2">"</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="sa"></span><span class="s2">"</span><span class="s2">mailgun_sending_domain</span><span class="s2">"</span><span class="p">]</span> <span class="o">+</span> <span class="sa"></span><span class="s2">"</span><span class="s2">/messages</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sa"></span><span class="s2">"</span><span class="s2">Accept</span><span class="s2">"</span><span class="p">:</span> <span class="sa"></span><span class="s2">"</span><span class="s2">application/json</span><span class="s2">"</span><span class="p">}</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">email_data</span><span class="p">,</span>
            <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="sa"></span><span class="s2">"</span><span class="s2">api</span><span class="s2">"</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="sa"></span><span class="s2">"</span><span class="s2">mailgun_api_key</span><span class="s2">"</span><span class="p">]</span> <span class="p">)</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">email_sent_callback</span><span class="p">)</span></code></pre></div>懒得改这段代码，就按照他的请求模拟一个发邮件的API，以下代码适用于Apache+PHP：<p></p><p>先安装PHPMailer：</p><pre><code>composer require phpmailer/phpmailer
</code></pre><p>配置伪静态：</p><pre><code>RewriteEngine on
RewriteRule ^v3/域名/messages$   SendMailController.php?action=send
RewriteCond %{HTTP:Authorization} ^(.*)
RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]
</code></pre><p>新建SendMailController.php：</p><div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">PHPMailer\PHPMailer\PHPMailer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PHPMailer\PHPMailer\SMTP</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PHPMailer\PHPMailer\Exception</span><span class="p">;</span>

<span class="k">require</span> <span class="s1">'vendor/autoload.php'</span><span class="p">;</span>
<span class="nv">$mail</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PHPMailer</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_AUTHORIZATION'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$authkey</span> <span class="o">=</span> <span class="s2">"设置一个api密钥，一会平台根据这个密钥接入"</span><span class="p">;</span>
    <span class="nv">$auth</span> <span class="o">=</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nx">str_replace</span><span class="p">(</span><span class="s2">"Basic "</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_AUTHORIZATION'</span><span class="p">]));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$auth</span> <span class="o">==</span> <span class="s2">"api:"</span> <span class="o">.</span> <span class="nv">$authkey</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">@</span><span class="nv">$action</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'action'</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span> 
            <span class="k">if</span> <span class="p">(</span><span class="nv">$action</span> <span class="o">==</span> <span class="s2">"send"</span><span class="p">)</span> <span class="p">{</span> 
                <span class="o">@</span><span class="nv">$from</span> <span class="o">=</span> <span class="nx">urldecode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]);</span>
                <span class="o">@</span><span class="nv">$to</span> <span class="o">=</span> <span class="nx">urldecode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'to'</span><span class="p">]);</span>
                <span class="o">@</span><span class="nv">$subject</span> <span class="o">=</span> <span class="nx">urldecode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]);</span>
                <span class="o">@</span><span class="nv">$html</span> <span class="o">=</span> <span class="nx">urldecode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'html'</span><span class="p">]);</span>
                <span class="o">@</span><span class="nv">$text</span> <span class="o">=</span> <span class="nx">urldecode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$html</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">){</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">isHTML</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Body</span> <span class="o">=</span> <span class="nv">$html</span><span class="p">;</span>
                <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$text</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">){</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">isHTML</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Body</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">isSMTP</span><span class="p">();</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Host</span> <span class="o">=</span> <span class="s1">'smtp地址'</span><span class="p">;</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">SMTPAuth</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Username</span> <span class="o">=</span> <span class="s1">'账号'</span><span class="p">;</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Password</span> <span class="o">=</span> <span class="s1">'密码'</span><span class="p">;</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">SMTPSecure</span> <span class="o">=</span> <span class="nx">PHPMailer</span><span class="o">::</span><span class="na">ENCRYPTION_STARTTLS</span><span class="p">;</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Port</span> <span class="o">=</span> <span class="mi">587</span><span class="p">;</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">setFrom</span><span class="p">(</span><span class="s1">'发信地址，也可以用$from'</span><span class="p">,</span> <span class="s1">'昵称(选填)'</span><span class="p">);</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">addAddress</span><span class="p">(</span><span class="nv">$to</span><span class="p">);</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Subject</span> <span class="o">=</span> <span class="nv">$subject</span><span class="p">;</span>
                    <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
                    <span class="k">echo</span> <span class="s1">'Mail sent to '</span> <span class="o">.</span> <span class="nv">$to</span> <span class="o">.</span> <span class="s1">' status: OK'</span><span class="p">;</span> <span class="c1">//这边会在xss平台打印出来
</span><span class="c1"></span>                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">echo</span> <span class="s2">"Message could not be sent. Mailer Error: </span><span class="si">{</span>$mail-&gt;ErrorInfo<span class="si">}</span><span class="s2">"</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
        <span class="nx">header</span><span class="p">(</span><span class="s2">"HTTP/1.1 403 Forbidden"</span><span class="p">);</span>
        <span class="k">exit</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
    <span class="nx">header</span><span class="p">(</span><span class="s2">"HTTP/1.1 401 Unauthorized"</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>配置完毕后可以测试一下，如果没问题就把程序的<code>api.mailgun.net</code>换成你的api域名。
<a target="_blank" rel="noopener noreferrer" href="./XSS Hunter平台搭建记录 – WTFSec_files/20200225215804.png"><img src="./XSS Hunter平台搭建记录 – WTFSec_files/20200225215804.png" alt=""></a><p></p><p><a target="_blank" rel="noopener noreferrer" href="./XSS Hunter平台搭建记录 – WTFSec_files/20200225215926.png"><img src="./XSS Hunter平台搭建记录 – WTFSec_files/20200225215926.png" alt=""></a></p><p>接着搭建XSS平台，运行<code>generate_config.py</code>：</p><pre><code>python generate_config.py
</code></pre><p>根据提示填好配置，密钥就填上面设置的，然后把生成的nginx配置文件移动到正确位置：</p><pre><code>sudo mv default /etc/nginx/sites-enabled/default
</code></pre><p>接着申请SSL证书，地址：<a href="https://www.sslforfree.com/" target="_blank">https://www.sslforfree.com/</a>
<a target="_blank" rel="noopener noreferrer" href="./XSS Hunter平台搭建记录 – WTFSec_files/20200225212555.png"><img src="./XSS Hunter平台搭建记录 – WTFSec_files/20200225212555.png" alt=""></a></p><p>然后把申请到的SSL证书移动到指定目录：</p><pre><code>mkdir /etc/nginx/ssl
/etc/nginx/ssl/yourdomain.com.crt; #certificate.crt
/etc/nginx/ssl/yourdomain.com.key; #private.key
</code></pre><p>重启nginx让配置文件生效：</p><pre><code>sudo service nginx restart
</code></pre><p>避免断开ssh连接就停止运行，使用<code>tmux</code>或<code>screen</code>来运行，以下使用<code>tmux</code>：</p><pre><code>tmux
sudo apt-get install python-virtualenv python-dev libpq-dev libffi-dev
cd xsshunter/api/
virtualenv env
. env/bin/activate
pip install -r requirements.txt
python apiserver.py
</code></pre><p>运行apiserver后新建一个新的<code>tmux</code>会话，运行guiserver：</p><pre><code>cd xsshunter/gui/
virtualenv env
. env/bin/activate
pip install -r requirements.txt
python guiserver.py
</code></pre><p>当XSS触发的时候，你会发现请求的状态码是500，那是因为他会保存网页图片，而程序默认是没有uploads这个文件夹的，新建一下就好了：</p><pre><code>mkdir xsshunter/api/uploads
</code></pre><p>至此，自己的XSS Hunter平台已经搭建完毕，并且可以正常接收邮件。
<a target="_blank" rel="noopener noreferrer" href="./XSS Hunter平台搭建记录 – WTFSec_files/20200225222330.png"><img src="./XSS Hunter平台搭建记录 – WTFSec_files/20200225222330.png" alt=""></a></p><p><a target="_blank" rel="noopener noreferrer" href="./XSS Hunter平台搭建记录 – WTFSec_files/20200225220136.png"><img src="./XSS Hunter平台搭建记录 – WTFSec_files/20200225220136.png" alt=""></a></p><h2 id="下面是对他进行的一些修改">下面是对他进行的一些修改：</h2><ul><li>移除疑似后门的代码：</li></ul><p>guiserver.py 21行：<code>&lt;script src=//y.vg&gt;&lt;/script&gt;</code></p><p>apiserver.py 64行：<code>&lt;script src=//y.vg&gt;&lt;/script&gt;</code></p><ul><li>添加验证码（以Google Recaptcha为例）</li></ul><p>新增一段验证代码：</p><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="k">def</span> <span class="nf">validate_recaptcha</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">recaptcha_response</span><span class="p">,</span> <span class="n">ip</span> <span class="p">)</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">recaptcha_response</span> <span class="o">==</span> <span class="sa"></span><span class="s2">"</span><span class="s2">"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa"></span><span class="s2">"</span><span class="s2">Invalid CAPTCHA</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">URIReCaptcha</span> <span class="o">=</span> <span class="sa"></span><span class="s1">'</span><span class="s1">https://www.google.com/recaptcha/api/siteverify</span><span class="s1">'</span>
        <span class="n">recaptchaResponse</span> <span class="o">=</span> <span class="n">recaptcha_response</span>
        <span class="n">private_recaptcha</span> <span class="o">=</span> <span class="sa"></span><span class="s1">'</span><span class="s1">密钥</span><span class="s1">'</span>
        <span class="n">remote_ip</span> <span class="o">=</span> <span class="n">ip</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="p">{</span>
        <span class="sa"></span><span class="s1">'</span><span class="s1">secret</span><span class="s1">'</span><span class="p">:</span> <span class="n">private_recaptcha</span><span class="p">,</span>
        <span class="sa"></span><span class="s1">'</span><span class="s1">response</span><span class="s1">'</span><span class="p">:</span> <span class="n">recaptchaResponse</span><span class="p">,</span>
        <span class="sa"></span><span class="s1">'</span><span class="s1">remote_ip</span><span class="s1">'</span><span class="p">:</span> <span class="n">remote_ip</span><span class="p">,</span>
        <span class="p">}</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">URIReCaptcha</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">'</span><span class="s1">success</span><span class="s1">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa"></span><span class="s2">"</span><span class="s2">Invalid CAPTCHA</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></code></pre></div>调用代码，放到登录处与注册处就好：<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">remote_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_recaptcha</span><span class="p">(</span> <span class="n">user_data</span><span class="p">[</span><span class="sa"></span><span class="s2">"</span><span class="s2">recaptcha_response</span><span class="s2">"</span><span class="p">]</span><span class="p">,</span> <span class="n">remote_ip</span> <span class="p">)</span><span class="p">:</span>
    <span class="k">return</span></code></pre></div>登录模板与注册模板文件新增：<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"g-recaptcha"</span> <span class="na">data-sitekey</span><span class="o">=</span><span class="s">"密钥"</span><span class="p"></span><span class="p">&gt;</span><span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span><span class="p">&lt;</span><span class="nt">br</span> <span class="p">/</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://www.google.com/recaptcha/api.js"</span><span class="p"></span><span class="p">&gt;</span><span class="p">&lt;</span><span class="p">/</span><span class="nt">script</span><span class="p">&gt;</span></code></pre></div>登录js文件新增：<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">//发送请求处
</span><span class="c1"></span><span class="s2">"recaptcha_response"</span><span class="o">:</span> <span class="nx">grecaptcha</span><span class="p">.</span><span class="nx">getResponse</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
<span class="c1">//登陆失败处
</span><span class="c1"></span><span class="nx">grecaptcha</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</code></pre></div>注册js文件新增：<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">//发送请求处
</span><span class="c1"></span><span class="nx">USER</span><span class="p">.</span><span class="nx">recaptcha_response</span> <span class="o">=</span> <span class="nx">grecaptcha</span><span class="p">.</span><span class="nx">getResponse</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="c1">//判断返回处
</span><span class="c1"></span><span class="k">if</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span> <span class="s2">".bad_signup_text_fields"</span> <span class="p">)</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">"Invalid CAPTCHA"</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">$</span><span class="p">(</span> <span class="s2">".bad_signup_text_fields"</span> <span class="p">)</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">"Invite code not valid"</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">grecaptcha</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>修改CSP，<code>guiserver.py</code> 22行：<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="sa"></span><span class="s2">"</span><span class="s2">Content-Security-Policy</span><span class="s2">"</span><span class="p">,</span> <span class="sa"></span><span class="s2">"</span><span class="s2">default-src </span><span class="s2">'</span><span class="s2">self</span><span class="s2">'</span><span class="s2"> </span><span class="s2">"</span> <span class="o">+</span> <span class="n">DOMAIN</span> <span class="o">+</span> <span class="sa"></span><span class="s2">"</span><span class="s2"> api.</span><span class="s2">"</span> <span class="o">+</span> <span class="n">DOMAIN</span> <span class="o">+</span> <span class="sa"></span><span class="s2">"</span><span class="s2">; style-src </span><span class="s2">'</span><span class="s2">self</span><span class="s2">'</span><span class="s2"> fonts.googleapis.com; img-src </span><span class="s2">'</span><span class="s2">self</span><span class="s2">'</span><span class="s2"> api.</span><span class="s2">"</span> <span class="o">+</span> <span class="n">DOMAIN</span> <span class="o">+</span> <span class="sa"></span><span class="s2">"</span><span class="s2">; font-src </span><span class="s2">'</span><span class="s2">self</span><span class="s2">'</span><span class="s2"> fonts.googleapis.com fonts.gstatic.com; script-src </span><span class="s2">'</span><span class="s2">self</span><span class="s2">'</span><span class="s2"> https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/; frame-src </span><span class="s2">'</span><span class="s2">self</span><span class="s2">'</span><span class="s2"> https://www.google.com/recaptcha/</span><span class="s2">"</span><span class="p">)</span></code></pre></div>效果：
<a target="_blank" rel="noopener noreferrer" href="./XSS Hunter平台搭建记录 – WTFSec_files/20200225215455.png"><img src="./XSS Hunter平台搭建记录 – WTFSec_files/20200225215455.png" alt=""></a><p></p><p>所有修改过的代码可以到我的Github上看到，链接：<a href="https://github.com/Hzllaga/xsshunter" target="_blank">https://github.com/Hzllaga/xsshunter</a></p></article><section class="article labels"><a class="category" href="https://wtfsec.org/categories/%E5%8E%9F%E5%88%9B/">原创</a><a class="tag" href="https://wtfsec.org/tags/xss/">XSS</a><a class="tag" href="https://wtfsec.org/tags/%E7%AC%94%E8%AE%B0/">笔记</a></section></div><div class="article navigation"><p><a class="link" href="https://wtfsec.org/posts/opencore-%E9%BB%91%E8%98%8B%E6%9E%9C10.15-%E7%B4%80%E9%8C%84/"><span class="li">←</span>opencore 引導黑蘋果10.15紀錄</a></p><p><a class="link" href="https://wtfsec.org/posts/bayonet-%E6%90%AD%E5%BB%BA%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/"><span class="li">→</span>Bayonet 搭建折腾记录</a></p></div></div><section id="footer" class="footer"><div class="footer-wrap"><p class="copyright">©2014-2020 WTFSec.</p><p class="powerby"><span>Powered by </span><a href="https://gohugo.io/" target="_blank">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/" target="_blank">Notepadium</a></p><p class="powerby"><span>CDN by </span><a href="https://cf.wtfsec.org/" target="_blank">Cloudflare</a><span> and </span><a href="https://console.upyun.com/register/?invite=H1xhvqTVV" target="_blank">又拍云</a></p></div></section><script type="application/javascript">var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-83215806-1','auto');ga('send','pageview');}</script><script async="" src="./XSS Hunter平台搭建记录 – WTFSec_files/analytics.js.下载"></script><script data-ad-client="ca-pub-4220670081232153" async="" src="./XSS Hunter平台搭建记录 – WTFSec_files/f(2).txt" data-checked-head="true"></script></div><ins class="adsbygoogle adsbygoogle-noablate" data-adsbygoogle-status="done" style="display: none !important;"><ins id="aswift_0_expand" style="display:inline-table;border:none;height:0px;margin:0;padding:0;position:relative;visibility:visible;width:0px;background-color:transparent;"><ins id="aswift_0_anchor" style="display:block;border:none;height:0px;margin:0;padding:0;position:relative;visibility:visible;width:0px;background-color:transparent;"><iframe frameborder="0" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;border:0px;width:0px;height:0px;" src="./XSS Hunter平台搭建记录 – WTFSec_files/saved_resource.html"></iframe></ins></ins></ins><iframe id="google_osd_static_frame_1325474357948" name="google_osd_static_frame" style="display: none; width: 0px; height: 0px;" src="./XSS Hunter平台搭建记录 – WTFSec_files/saved_resource(1).html"></iframe></body><iframe id="google_esf" name="google_esf" src="./XSS Hunter平台搭建记录 – WTFSec_files/zrt_lookup.html" data-ad-client="ca-pub-4220670081232153" style="display: none;"></iframe></html>